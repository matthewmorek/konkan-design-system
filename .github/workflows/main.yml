name: Supernova <> Figma Token sync
on:
  # Any branch you want
  push:
    branches:
      - feature/*
  workflow_dispatch:

jobs:
  sync_tokens:
    runs-on: ubuntu-latest
    steps:
      # Check out repository under $GITHUB_WORKSPACE, so the CLI utility can read it
      - uses: actions/checkout@v3
      # Setup node to use with CLI. 14+ is required
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      # Install Supernova CLI
      - name: Install Supernova CLI dependency
        run: npm install --g @supernovaio/cli

      # Sync tokens
      - name: Synchronize tokens with Supernova
        run: |
          supernova sync-tokens \
          --apiKey="${{ secrets.SUPERNOVA_API_KEY }}" \
          --designSystemId="24475" \
          --tokenDirPath="${{ github.workspace }}/design-tokens" \
          --configFilePath="${{ github.workspace }}/supernova.settings.json"

      # Slack integration
      - name: Slack notification
        uses: 8398a7/action-slack@v3.15.1
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        with:
          status: custom
          fields: repo,message,commit,author,action,eventName,ref,workflow,job,took
          custom_payload: |
            {
              "attachments": [
                {
                  "color": "good",
                  "blocks": [
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": `*Workflow:* ${workflow.name}`
                        },
                        {
                          "type": "mrkdwn",
                          "text": `*Status:* ${job.status}`
                        }
                      ]
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "image",
                          "image_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
                          "alt_text": "github icon"
                        },
                        {
                          "type": "mrkdwn",
                          "text": `<${process.env.GITHUB_SERVER_URL}/${repo}|${repo}> | ${workflow.name}`
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        if: always()
